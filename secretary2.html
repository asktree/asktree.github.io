<!DOCTYPE html>
<meta charset="utf-8">
<link href="https://fonts.googleapis.com/css?family=Roboto|Roboto+Slab" rel="stylesheet">
<style type='text/css'>
.maineditor {
	font-family: 'Roboto', sans-serif;
	resize: none;
	width: 100%;
	height: 100%;
	//position:absolute;
	padding: 1em;
}

.note {
	background-color: rgba(0,0,0,0);
	margin: 2px;
	border: dashed;
	border-color: #ddd;
	border-radius: .5em;
	border-width: 1px;
	padding: .3em;
	min-height: 1em;
}

body {
	margin: 0px;
}
</style>
<body>
<div id="root">
	<div contenteditable="true" autofocus="true" class="maineditor" id="main"><div class="note"></div></div>
</div>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="http://ichord.github.io/Caret.js/src/jquery.caret.js"></script>
<script>

$('#main').on('keydown', function (e) {
	var keyCode = e.keyCode || e.which;

	if (keyCode == 9 || keyCode == 13) {
		var sel = document.getSelection(),
		node = sel.anchorNode,
		element = node;
		if (element.nodeType == 3) {
			element = node.parentElement;
		}
		console.log($(node))
		/*
		if (keyCode == 9) {
			e.preventDefault();
			child = element.previousElementSibling.appendChild(element);
			$(child).caret('pos', 0); //apparently broken
		
		} else */ if (keyCode == 13) {
			if (element.textContent.slice(0, sel.focusOffset) == "") {
				e.preventDefault();
				element.parentElement.parentElement.insertBefore(element, element.parentElement.nextSibling);
			}
			else if ($(element).text().slice(0, sel.focusOffset).slice(-1) == ":"){
				e.preventDefault();
				child = element.appendChild(element.cloneNode());
				$(child).caret('pos', 1); //apparently broken
			}
			
		}

	}

});

$('#main').on('input', oninput)

function oninput(event) {
	//the editor eats bare newlines... here's my dumb solution
	/*if (l[l.length-1] != "") {
	$(this).html(t + "\n")
	}
	 */
}

function update(html) {}

function notify(item) {
	if (item.slice(0, 4) != "<div") {
		return "<div class=\'note\'>" + item + "</div>"
	} else {
		return item
	}
}

function showme() {
	return lines = $('#main').html();
}


</script>
</body>