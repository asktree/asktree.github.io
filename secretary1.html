<!DOCTYPE html>
<meta charset="utf-8">
<link href="https://fonts.googleapis.com/css?family=Roboto|Roboto+Slab" rel="stylesheet">
<style type='text/css'>
.maineditor {
	font-family: 'Roboto', sans-serif;
	resize: none;
	width: 100%;
	height: 100%;
	//position:absolute;
	padding: 1em;
}

.note {
	background-color: #ddd;
}

body {
	margin: 0px;
}
</style>
<body>
<div id="root">
	<pre><div contenteditable="true" autofocus="true" class="maineditor" id="main"></div></pre>
</div>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="http://ichord.github.io/Caret.js/src/jquery.caret.js"></script>
<script>

$(document).delegate('#main', 'keydown', function(e) {
  var keyCode = e.keyCode || e.which;
  
  if (keyCode == 9 || keyCode == 13) {
	e.preventDefault();
	var start = $(this).caret('pos'),
		html = $(this).html(),
		hstart = htmlFindPos(html, start),
		htmlbefore = html.slice( 0, hstart),
		htmlafter = html.slice(hstart);
	  
	if (keyCode == 9) {
		// set textarea value to: text before caret + tab + text after caret
		$(this).html(htmlbefore
					+ "	"
					+ htmlafter);

		// put caret at right position again
		$('#main').caret('pos', start+1); 
	  }
	  
	else if (keyCode == 13) {
		// set textarea value to: text before caret + newline + text after caret
		$(this).html(htmlbefore
					+ "\n"
					+ htmlafter);

		// put caret at right position again
			h = $(this).html()//.slice(0, -1);
			update(h)
		
		$('#main').caret('pos', start+1); 
	  }
  }
  
});

$('#main').on('input', oninput)


function oninput(event) {
	c = $(this).caret('pos'); 
	t = $(this).html();
	l = t.split('\n');
	
	//the editor eats bare newlines... here's my dumb solution
	/*if (l[l.length-1] != "") {
		$(this).html(t + "\n")
	}
	*/
	  
	h = $(this).html()//.slice(0, -1);
	update(h)
	
	$(this).caret('pos', c)
}

function update(html) {
	lines = h.split('\n');
	items = h.split('\n\n');
	console.log(items)
	
	itemsfinal = []
	items.forEach(function(item) {
		itemsfinal.push(notify(item))
	})
	updated = itemsfinal.join('\n\n');
	$("#main").html(updated);
}

function notify(item) {
	if (item.slice(0, 4) != "<div") {
		return "<div class=\'note\'>" + item + "</div>"
	}
	else {
		return item
	}
}

function showme() {
	return lines = $('#main').html();
}

function htmlFindPos(htmlstring, pos){
	var hpos = 0,
		inc = 1,
		i = 0;
	while (hpos < pos){
		if (inc == 1){
			if (htmlstring[i] != "<"){
				hpos += 1;
			}
			else {
				inc = 0;
			}
		}
		else {
			if (htmlstring[i] == ">"){
				inc = 1;
			}
		}
		i += 1;
	}
	return i
}


</script>
</body>